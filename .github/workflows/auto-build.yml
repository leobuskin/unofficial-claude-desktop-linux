name: Auto Build Claude Desktop for Linux

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC
  workflow_dispatch:     # Allow manual triggers
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - '.github/workflows/auto-build.yml'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.version_check.outputs.should_build }}
      new_version: ${{ steps.version_check.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: playwright install chromium

      - name: Check for new version
        id: version_check
        run: |
          # Get latest version from Claude (URL resolution only, no download)
          LATEST_VERSION=$(python -c "
          from builder.sources import get_source_handler
          handler = get_source_handler('windows')
          version = handler.get_latest_version()
          if version:
              print(version)
          else:
              raise SystemExit('Failed to get latest version')
          ")

          echo "Latest Claude version: $LATEST_VERSION"
          echo "new_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

          # Check if we already built this version
          if gh release view "v$LATEST_VERSION" >/dev/null 2>&1; then
            echo "Version $LATEST_VERSION already built"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "New version $LATEST_VERSION detected!"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  build-packages:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('src/native/patchy-cnb/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Cache Claude installer
        uses: actions/cache@v4
        with:
          path: .cache/downloads
          key: claude-installer-${{ hashFiles('.cache/downloads/metadata.json') }}
          restore-keys: |
            claude-installer-
      
      - name: Cache native module build
        uses: actions/cache@v4
        with:
          path: |
            build/native-module/target
            build/native-module/*.node
          key: ${{ runner.os }}-native-module-${{ hashFiles('src/native/patchy-cnb/**') }}
          restore-keys: |
            ${{ runner.os }}-native-module-
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            p7zip-full \
            nodejs \
            npm \
            cargo \
            rustc \
            imagemagick \
            icoutils \
            icnsutils \
            rpm
      
      - name: Enable Corepack and install package managers
        run: |
          # Enable corepack for yarn and pnpm
          corepack enable
          # Pre-install the required yarn version
          corepack prepare yarn@4.5.3 --activate
          # Install asar for extraction (pnpm is already available via corepack)
          npm install -g asar
      
      - name: Install Python package
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: playwright install chromium

      - name: Build packages
        id: build
        run: |
          # Build the packages
          claude-desktop-build build
          
          # Find the built .deb file
          DEB_FILE=$(find packages -name "*.deb" | head -1)
          echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT
          echo "version=${{ needs.check-version.outputs.new_version }}" >> $GITHUB_OUTPUT
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: packages/

  create-release:
    needs: [check-version, build-packages]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: packages
          path: packages/
      
      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.check-version.outputs.new_version }}"
          REPO="${{ github.repository }}"
          
          # Create release notes
          cat > release_notes.md << EOF
          ## Unofficial Claude Desktop $VERSION for Linux
          
          This release was automatically built from the official Claude Desktop Windows/MacOS installer.
          
          ### Installation
          
          #### Debian/Ubuntu:
          \`\`\`bash
          sudo dpkg -i claude-desktop_${VERSION}_amd64.deb
          \`\`\`
          
          ### Changes
          - Automatically detected and built from upstream version $VERSION
          - Built on: $(date -u +"%Y-%m-%d %H:%M UTC")
          
          ### Verification
          All packages are built using GitHub Actions for transparency and reproducibility.
          EOF
          
          # Create GitHub release
          gh release create "v$VERSION" \
            --title "Claude Desktop $VERSION" \
            --notes-file release_notes.md \
            packages/*.deb